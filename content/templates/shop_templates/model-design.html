{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Instrument Design</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            background-color: #000000;
            margin: 0px;
            overflow: hidden;
            font-family: Monospace;
            font-size: 13px;
            text-align: center;
            font-weight: bold;
        }

        a {
            color: #00ff78;
        }

        #info {
            color: #fff;
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            display: block;
        }

        .dg.ac {
            z-index: 1 !important; /* FIX DAT.GUI */
        }
    </style>
</head>
<body>

<script type="text/javascript" src="{% static "assets/js/jquery-2.1.4.min.js" %}"></script>
<script type="text/javascript" src="{% static "assets/js_for_model/three.js" %}"></script>
<script type="text/javascript" src="{% static "assets/js_for_model/LoaderSupport.js" %}"></script>
<script type="text/javascript" src="{% static "assets/js_for_model/OBJLoader.js" %}"></script>
<script type="text/javascript" src="{% static "assets/js_for_model/GLTFLoader.js" %}"></script>
<script type="text/javascript" src="{% static "assets/js_for_model/DDSLoader.js" %}"></script>
<script type="text/javascript" src="{% static "assets/js_for_model/TrackballControls.js" %}"></script>
<script type="text/javascript" src="{% static "assets/js_for_model/Detector.js" %}"></script>
<script type="text/javascript" src="{% static "assets/js_for_model/EffectComposer.js" %}"></script>
<script type="text/javascript" src="{% static "assets/js_for_model/OutlinePass.js" %}"></script>
<script type="text/javascript" src="{% static "assets/js_for_model/RenderPass.js" %}"></script>
<script type="text/javascript" src="{% static "assets/js_for_model/CopyShader.js" %}"></script>
<script type="text/javascript" src="{% static "assets/js_for_model/ShaderPass.js" %}"></script>
<script type="text/javascript" src="{% static "assets/js_for_model/FXAAShader.js" %}"></script>
<script type="text/javascript" src="{% static "assets/js_for_model/TweenLite.min.js" %}"></script>
<script type="text/javascript" src="{% static "assets/js_for_model/OrbitControls.js" %}"></script>
<script type="text/javascript" src="{% static "assets/js_for_model/dat.gui.min.js" %}"></script>
<script type="text/javascript" src="{% static "assets/js_for_model/stats.min.js" %}"></script>

<script type="text/javascript" src="{% static "assets/js_for_model/model_split_and_merge.js" %}"></script>

<div id="info">
    <a href="http://threejs.org" target="_blank" rel="noopener">Develop based on three.js</a> - Instrument Model Design
    by <a
        href="http://eduperiment.com" target="_blank" rel="noopener">Group 8</a><br/><br/>
</div>

<script type="text/javascript">
    console.log("访问格式：http://127.0.0.1:8000/model_design/guitar_style_1" + "\n" +
        "http://127.0.0.1:8000/model_design/guitar_style_2" + "\n" +
        "http://127.0.0.1:8000/model_design/guitar_style_3" + "\n" +
        "http://127.0.0.1:8000/model_design/piano_style_1");
    let model_id = "guitar_style_3";
    model_id = "{{ model_id|safe }}";


    if (model_id === "guitar_style_1") {
        model_name = "model_design_guitar.gltf";
    } else if (model_id === "guitar_style_2") {
        model_name = "model_design_guitar2.gltf";
    } else if (model_id === "guitar_style_3") {
        model_name = "model_design_guitar3.gltf";
    } else if (model_id === "piano_style_1") {
        model_name = "model_design_piano.gltf";
    } else {
        let info = "访问格式：http://127.0.0.1:8000/model_design/guitar_style_1" + "\n" +
            "http://127.0.0.1:8000/model_design/guitar_style_2" + "\n" +
            "http://127.0.0.1:8000/model_design/guitar_style_3" + "\n" +
            "http://127.0.0.1:8000/model_design/piano_style_1";
        console.log(model_id, info);
        alert(info);
        model_name = "model_design_piano.gltf";
    }


    if (!Detector.webgl) Detector.addGetWebGLMessage();

    var container, stats;
    var camera, scene, renderer, controls;
    var raycaster = new THREE.Raycaster();

    var mouse = new THREE.Vector2();
    var selectedObjects = [];

    var composer, effectFXAA, outlinePass;
    var obj3d = new THREE.Object3D();

    var group = new THREE.Group();

    var params = {
        edgeStrength: 3.0,
        edgeGlow: 0.0,
        edgeThickness: 1.0,
        pulsePeriod: 0,
        rotate: false,
        usePatternTexture: false
    };

    // Init gui

    var gui = new dat.GUI({width: 300, minHeight: 1000});

    {# model  #}
    var deposite = new function () {
        this.merge_model = function () {
            // find the mesh of loaded model to iterater
            scene.children[scene.children.length - 1].children[0].children[0].children.forEach(function (mesh) {
                specific_model_merge(mesh, model_id);
            })
        }
        this.split_model = function () {
            {#console.log("model spilted");#}
            {#console.log("scene.children[2].children[0].children", scene.children[scene.children.length - 1].children[0].children[0].children);#}
            // find the mesh of loaded model to iterater
            scene.children[scene.children.length - 1].children[0].children[0].children.forEach(function (mesh) {
                specific_model_split(mesh, model_id);
            })
        }
        this.select_color = "#ffffff" // CSS string
    };


    gui.add(deposite, 'split_model');
    gui.add(deposite, 'merge_model');
    var colorController = gui.addColor(deposite, "select_color");

    //对应控制项值改变时响应
    colorController.onChange(function (value) {
        console.log("onChange for selected color:", selectedObjects, value);
        {#selectedObjects[0].material.color = value;#}
        let newMaterial = selectedObjects[0].material.clone();
        newMaterial.color = new THREE.Color(value); //重新修改颜色
        selectedObjects[0].material = newMaterial;
    });

    gui.add(params, 'edgeStrength', 0.01, 10).onChange(function (value) {
        outlinePass.edgeStrength = Number(value);
    });
    gui.add(params, 'edgeGlow', 0.0, 1).onChange(function (value) {
        outlinePass.edgeGlow = Number(value);
    });
    gui.add(params, 'edgeThickness', 1, 4).onChange(function (value) {
        outlinePass.edgeThickness = Number(value);
    });
    gui.add(params, 'pulsePeriod', 0.0, 5).onChange(function (value) {
        outlinePass.pulsePeriod = Number(value);
    });

    gui.add(params, 'rotate');

    gui.add(params, 'usePatternTexture').onChange(function (value) {
        outlinePass.usePatternTexture = value;
    });

    var Configuration = function () {
        this.visibleEdgeColor = '#fdeaa1';
        this.hiddenEdgeColor = '#190a05';
    };

    var conf = new Configuration();

    var controllerVisible = gui.addColor(conf, 'visibleEdgeColor').onChange(function (value) {

        outlinePass.visibleEdgeColor.set(value);

    });

    var controllerHidden = gui.addColor(conf, 'hiddenEdgeColor').onChange(function (value) {

        outlinePass.hiddenEdgeColor.set(value);

    });

    init();
    animate();
    let state_changeColor = false;

    {#gui.remember(deposite);#}
    {#gui.domElement.style = 'height:100%';#}

    function init() {


        container = document.createElement('div');
        document.body.appendChild(container);

        var width = window.innerWidth;
        var height = window.innerHeight;

        renderer = new THREE.WebGLRenderer({antialias: false});
        renderer.shadowMap.enabled = true;
        renderer.setSize(width, height);
        document.body.appendChild(renderer.domElement);

        {#scene = new THREE.Scene();#}

        // scene 创建一个场景
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xB3CEFB);
        scene.fog = new THREE.Fog(scene.background, 1, 100);


        camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 100);
        camera.position.set(0, 0, 8);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.minDistance = 5;
        controls.maxDistance = 20;
        controls.enablePan = false;
        controls.enableDamping = true;
        controls.dampingFactor = 0.25;


        scene.add(new THREE.AmbientLight(0xaaaaaa, 0.6));

        var light = new THREE.DirectionalLight(0xddffdd, 0.7);
        light.position.set(1, 1, 1);

        light.castShadow = true;

        light.shadow.mapSize.width = 1024;
        light.shadow.mapSize.height = 1024;

        var d = 10;

        light.shadow.camera.left = -d;
        light.shadow.camera.right = d;
        light.shadow.camera.top = d;
        light.shadow.camera.bottom = -d;

        light.shadow.camera.far = 1000;

        scene.add(light);


        var light2 = new THREE.DirectionalLight(0xddffdd, 0.4);
        light2.position.set(-1, 0.1, 0);

        light2.castShadow = false;

        light2.shadow.mapSize.width = 1024;
        light2.shadow.mapSize.height = 1024;

        var d = 10;

        light2.shadow.camera.left = -d;
        light2.shadow.camera.right = d;
        light2.shadow.camera.top = d;
        light2.shadow.camera.bottom = -d;

        light2.shadow.camera.far = 1000;

        scene.add(light2);

        {##}
        var light3 = new THREE.DirectionalLight(0xddffdd, 0.2);
        light3.position.set(0.5, -0.2, 0);

        light3.castShadow = false;

        light3.shadow.mapSize.width = 1024;
        light3.shadow.mapSize.height = 1024;

        var d = 10;

        light3.shadow.camera.left = -d;
        light3.shadow.camera.right = d;
        light3.shadow.camera.top = d;
        light3.shadow.camera.bottom = -d;

        light3.shadow.camera.far = 1000;

        scene.add(light3);

        // model

        var manager = new THREE.LoadingManager();
        manager.onProgress = function (item, loaded, total) {
            console.log(item, loaded, total);
        };

        {#cubeDr(4, 0, 2, 0)#}
        {#cubeDr(4, 0, 2, 0)#}
        {#cubeDr(4, 5, 2, 0)#}
        {#cubeDr(4, -4, 2, 0)#}
        {##}
        {#function cubeDr(a, x, y, z) {#}
        {#    var cubeGeo = new THREE.BoxGeometry(a, a, a);#}
        {#    var cubeMat = new THREE.MeshPhongMaterial({#}
        {#        color: 0xfff000 * Math.random()#}
        {#    });#}
        {#    var cube = new THREE.Mesh(cubeGeo, cubeMat);#}
        {#    cube.position.set(x, y, z);#}
        {#    cube.castShadow = true;#}
        {#    scene.add(cube);#}
        {#    return cube;#}
        {#/}#}
        {##}

        var loader = new THREE.GLTFLoader();
        loader.load("{% static "assets/design_model/" %}" + model_name, function (gltf) {
            gltf.scene.traverse(function (child) {
                if (child.isMesh) {
                    {#if (child.name.includes('ere')) {#}
                    {#    child.material.color.set("rgb(67, 160, 71)")#}
                    {#\}#}
                    {#console.log("模型部件", child.name);#}
                    child.frustumCulled = false;
                    //模型阴影
                    child.castShadow = true;
                    {#//模型自发光#}
                    {#child.material.emissive = child.material.color;#}
                    {#child.material.emissiveMap = child.material.map;#}
                }
            });
            gltf.scene.scale.set(1, 1, 1) // scale here
            {#scene.add(gltf);#}
            obj3d.add(gltf.scene);
            {#obj3d.add(gltf.scene);#}
        });


        {#var loader = new THREE.OBJLoader2(manager);#}
        {#loader.load('models/obj/tree.obj', function (object) {#}
        {##}
        {#    var scale = 1.0;#}
        {##}
        {#    object.traverse(function (child) {#}
        {##}
        {#        if (child instanceof THREE.Mesh) {#}
        {##}
        {#            child.geometry.center();#}
        {#            child.geometry.computeBoundingSphere();#}
        {#            scale = 0.2 * child.geometry.boundingSphere.radius;#}
        {##}
        {#            var phongMaterial = new THREE.MeshPhongMaterial({#}
        {#                color: 0xffffff,#}
        {#                specular: 0x111111,#}
        {#                shininess: 5#}
        {#            });#}
        {#            child.material = phongMaterial;#}
        {#            child.receiveShadow = true;#}
        {#            child.castShadow = true;#}
        {##}
        {#        }#}
        {##}
        {#    });#}
        {##}
        {#    object.position.y = 1;#}
        {#    object.scale.divideScalar(scale);#}
        {#    obj3d.add(object);#}
        {##}
        {#\});#}

        scene.add(group);

        group.add(obj3d);

        //
        var floorMaterial = new THREE.MeshLambertMaterial({
            color: 0x77F28F,
            shininess: 0,
            // wireframe: true
        });
        var floorGeometry = new THREE.PlaneBufferGeometry(500, 500);
        var floorMesh = new THREE.Mesh(floorGeometry, floorMaterial);
        floorMesh.rotation.x -= Math.PI * 0.5;
        floorMesh.position.y -= 1.5;
        group.add(floorMesh);
        floorMesh.receiveShadow = true;

        {#var geometry = new THREE.TorusBufferGeometry(1, 0.3, 16, 100);#}
        {#var material = new THREE.MeshPhongMaterial({color: 0xffaaff});#}
        {#var torus = new THREE.Mesh(geometry, material);#}
        {#torus.position.z = -4;#}
        {#group.add(torus);#}
        {#torus.receiveShadow = true;#}
        {#torus.castShadow = true;#}

        //

        stats = new Stats();
        container.appendChild(stats.dom);

        // postprocessing

        composer = new THREE.EffectComposer(renderer);

        var renderPass = new THREE.RenderPass(scene, camera);
        composer.addPass(renderPass);

        outlinePass = new THREE.OutlinePass(new THREE.Vector2(window.innerWidth, window.innerHeight), scene, camera);
        composer.addPass(outlinePass);

        var onLoad = function (texture) {
            outlinePass.patternTexture = texture;
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;
        };

        effectFXAA = new THREE.ShaderPass(THREE.FXAAShader);
        effectFXAA.uniforms['resolution'].value.set(1 / window.innerWidth, 1 / window.innerHeight);
        effectFXAA.renderToScreen = true;
        composer.addPass(effectFXAA);

        window.addEventListener('resize', onWindowResize, false);

        {#window.addEventListener('mousemove', onTouchMove);#}
        {#window.addEventListener('touchmove', onTouchMove);#}

        window.addEventListener('click', onTouchMove);

        function onTouchMove(event) {
            var x, y;
            if (event.changedTouches) {
                x = event.changedTouches[0].pageX;
                y = event.changedTouches[0].pageY;
            } else {
                x = event.clientX;
                y = event.clientY;
            }
            mouse.x = (x / window.innerWidth) * 2 - 1;
            mouse.y = -(y / window.innerHeight) * 2 + 1;
            checkIntersection();
        }

        function addSelectedObject(object) {
            selectedObjects = [];
            selectedObjects.push(object);
            {#if (selectedObjects.length !== 0)#}
            {#    state_changeColor = true;#}
            {#else#}
            {#    state_changeColor = false;#}
        }

        function checkIntersection() {
            raycaster.setFromCamera(mouse, camera);
            var intersects = raycaster.intersectObjects([scene], true);
            if (intersects.length > 0) {
                var selectedObject = intersects[0].object;
                addSelectedObject(selectedObject);
                outlinePass.selectedObjects = selectedObjects;
            } else {
                // outlinePass.selectedObjects = [];
            }

        }

    }

    function onWindowResize() {
        var width = window.innerWidth;
        var height = window.innerHeight;

        camera.aspect = width / height;
        camera.updateProjectionMatrix();

        renderer.setSize(width, height);
        composer.setSize(width, height);

        effectFXAA.uniforms['resolution'].value.set(1 / window.innerWidth, 1 / window.innerHeight);

    }

    function animate() {
        requestAnimationFrame(animate);
        stats.begin();
        var timer = performance.now();
        if (params.rotate) {
            group.rotation.y = timer * 0.0001;
        }
        controls.update();
        composer.render();
        stats.end();
    }


</script>
</body>
</html>
